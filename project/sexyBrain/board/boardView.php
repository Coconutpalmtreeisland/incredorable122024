<?php
    include "../connect/connect.php";
    include "../connect/session.php";

    if(isset($_SESSION['memberId'])){
        $memberId = $_SESSION['memberId'];
    } else {
        $memberId = 0;
    }

    if(isset($_GET['boardId'])){
        $boardId = $_GET['boardId'];
    } else {
        Header("Location: board.php");
    }
    $youId = $_SESSION['youId'];

    // Ï°∞ÌöåÏàò Ï∂îÍ∞Ä
    $updateViewSql = "UPDATE sexyBoard SET boardView = boardView +1 WHERE boardId = '$boardId'";
    $connect -> query($updateViewSql);

    // Ï°∞ÌöåÏàò Î∂àÎü¨Ïò§Í∏∞
    $boardView = "SELECT boardView FROM sexyBoard WHERE boardId = '$boardId'";
    $boardViewResult = $connect -> query($boardView);
    $boardViewInfo = $boardViewResult -> fetch_array(MYSQLI_ASSOC);

    // Í≤åÏãúÍ∏Ä Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
    $boardSql = "SELECT * FROM sexyBoard WHERE boardId = '$boardId'";
    $boardResult = $connect -> query($boardSql);
    $boardInfo = $boardResult -> fetch_array(MYSQLI_ASSOC);

    // Ïù¥Ï†ÑÍ∏Ä Í∞ÄÏ†∏Ïò§Í∏∞
    $preBoardSql = "SELECT * FROM sexyBoard WHERE boardId < '$boardId' ORDER BY boardId DESC LIMIT 1";
    $preBoardResult = $connect -> query($preBoardSql);
    $preBoardInfo = $preBoardResult -> fetch_array(MYSQLI_ASSOC);

    // Îã§ÏùåÍ∏Ä Í∞ÄÏ†∏Ïò§Í∏∞
    $nextBoardSql = "SELECT * FROM sexyBoard WHERE boardId > '$boardId' ORDER BY boardId ASC LIMIT 1";
    $nextBoardResult = $connect -> query($nextBoardSql);
    $nextBoardInfo = $nextBoardResult -> fetch_array(MYSQLI_ASSOC);

    // ÎåìÍ∏Ä Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
    $commentSql = "SELECT * FROM sexyComment WHERE boardId = '$boardId' AND commentDelete = '1' ORDER BY commentId ASC";
    $commentResult = $connect -> query($commentSql);
    $commentInfo = $commentResult -> fetch_array(MYSQLI_ASSOC);

    $isAuthor = ($youId == $boardInfo['boardAuthor']);
?>

<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎáåÏÑπÎÇ®ÎÖÄ Í∏ÄÎ≥¥Í∏∞</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
    <div id="boardWrap">
        <?php include "../include/header__login.php"?>
        <!-- //#header -->

        <main id="boardMain">
            <div id="b_write_wrap">
                <div class="write_board"></div>
                <div class="view__wrap">
                    <form action="boardWriteSave.php" name="boardWriteSave" method="post" class="board_write">
                        <div class="board__view">
                            <section class="table__inner">
                                    <table>
                                        <tbody class="tby">
                                            <tr>
                                                <th>Ï†úÎ™©</th>
                                                <td><?=$boardInfo['boardTitle']?></td>
                                            </tr>
                                            <tr>
                                                <th>Îì±Î°ùÏùº</th>
                                                <td class="date"><?=date('Y-m-d', $boardInfo['boardRegTime'])?></td>
                                            </tr>
                                            <tr>
                                                <th>Ï°∞ÌöåÏàò</th>
                                                <td>Ï°∞ÌöåÏàò <?=$boardViewInfo['boardView']?></td>
                                            </tr>
                                            <tr>
                                                <th>ÎÇ¥Ïö©</th>
                                                <td class="b_contents_style" style="text-align: left; line-height: 1.6rem;">
                                                    <img  class="contImg" src="../assets/board/<?=$boardInfo['boardImgFile']?>" alt="<?=$boardInfo['boardTitle']?>">
                                                    <?=$boardInfo['boardContents']?>
                                                </td>
                                                <tr>
                                                    <th>Îì±Î°ùÏûê</td>
                                                    <td class="writer">ÏûëÏÑ±Ïûê <?=$boardInfo['boardAuthor']?></td>
                                                </tr>
                                            </tr>
                                            <tr>
                                                <th>Í≤åÏãúÍ∏Ä Ïù¥Îèô</th>
                                                <td class="board__index">
                                                    <?php if(!empty($preBoardInfo)){?>
                                                        <a href="boardView.php?boardId=<?=$preBoardInfo['boardId']?>" class="prev">
                                                            Ïù¥Ï†Ñ Í∏Ä <?=substr($preBoardInfo['boardTitle'], 0, 20)?>...
                                                        </a>
                                                    <?php } else {?>
                                                        <span>Ïù¥Ï†Ñ Í∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</span>
                                                    <?php }?>

                                                    <?php if(!empty($nextBoardInfo)){?>
                                                        <a href="boardView.php?boardId=<?=$nextBoardInfo['boardId']?>" class="next">
                                                            Îã§Ïùå Í∏Ä <?=substr($nextBoardInfo['boardTitle'], 0, 20)?>...
                                                        </a>
                                                    <?php } else {?>
                                                        <span class="next">Îã§Ïùå Í∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</span>
                                                    <?php }?>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                            </section>
                            <div class="board__btns">
                                <a href="board.php" class="btn__style03 m10aa">Î™©Î°ùÎ≥¥Í∏∞</a>
<?php if($isAuthor) { ?> 
    <a href="boardModify.php?boardId=<?= $_GET['boardId'] ?>" class="btn__style03 m10aa">ÏàòÏ†ïÌïòÍ∏∞</a>
    <a href="boardDelete.php?boardId=<?= $_GET['boardId'] ?>" class="btn__style03 m10aa" onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">ÏÇ≠Ï†úÌïòÍ∏∞</a>
<?php } ?>
                            </div>
                        </div>
                    </form>

                    <section id="boardComment" class="board__comment">
                        <h4>ÎåìÍ∏Ä</h4>
                        <div class="comment">
                            <div class="comment__input">
                                <form action="boardCommentWrite.php" method="POST">
                                    <fieldset>
                                        <legend class="blind">ÎåìÍ∏Ä Ïì∞Í∏∞</legend>
                                        <button type="button" id="commentWriteBtn" class="check-login">ÏûëÏÑ±ÌïòÍ∏∞</button>
                                        <label for="commentWrite" class="blind">ÎåìÍ∏ÄÏì∞Í∏∞</label>
                                        <input type="hidden" name="boardId" value="<?=$boardId?>">
                                        <input type="text" id="commentWrite" name="msg" class="commentWrite" placeholder="ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî" required>
                                    </fieldset>
                                </form>
                                <div class="comment__view">
<?php
    if ($commentResult->num_rows == 0) { ?>
            <div class="comment_wrap">
                <div class="text">
                    <span>
                        <span>ÏïÑÎ¨¥Îü∞ ÌùîÏ†ÅÏù¥ ÏóÜÏñ¥!!</span>
                        <p>ÎåìÍ∏ÄÏù¥ ÏóÜÏñ¥! üò® ÏûëÏÑ±Ìï¥Îùº!</p>
                    </span>
                </div>
            </div>
<?php } else {
        foreach ($commentResult as $comment) { ?>
                <div class="comment_wrap">
                    <div class="text">
                        <span>
                            <span class="author"><?= $comment['commentName'] ?></span>
                            <span class="date"><?= date('Y-m-d H:i', $comment['regTime']) ?></span>
                            <a href="#" class="modify" data-comment-id="<?= $comment['commentId'] ?>">ÏàòÏ†ï</a>
                            <a href="#" class="delete" data-comment-id="<?= $comment['commentId'] ?>">ÏÇ≠Ï†ú</a>
                        </span>
                        <p><?= $comment['commentMsg'] ?></p>
                    </div>
                </div>

<?php }}?>
                            </div>
                        </div>
                    </section>
                </div>      
            </div>
        </main>
        <!-- main -->

        <?php include "../include/footer.php"?>
        <!-- //footer -->
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script>
$(document).ready(function(){
            let isLoggedIn = <?php echo isset($_SESSION['youId']) ? 'true' : 'false'; ?>;
            $('#commentWriteBtn').click(function(e){
                if (!isLoggedIn) {
                    e.preventDefault(); 
                    alert('ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.'); 
                } else if ($("#commentWrite").val().trim() == "") {
                    e.preventDefault();
                    alert("ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!");
                    $("#commentWrite").focus();
                } else {
                    $.ajax({
                    url: "boardCommentWrite.php",
                    method: "POST",
                    dataType: "json",
                    data: {
                        "boardId": <?=$boardId?>,
                        "memberId": <?=$memberId?>,
                        "msg": $("#commentWrite").val(),
                    },
                    success: function(data){
                        console.log(data);
                        location.reload();
                    },
                    error: function(request, status, error){
                        console.log("request: " + request);
                        console.log("status: " + status);
                        console.log("error: " + error);
                    }
                })
                }
            });
        });

        $(".delete").click(function(e){
            e.preventDefault();
            let commentId = $(this).data("comment-id");
            if (confirm("ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                $.ajax({
                    url: "boardCommentDelete.php",
                    method: "POST",
                    data: {
                        "boardId": <?=$boardId?>,
                        "commentId": commentId,
                    },
                    success: function(data){
                        location.reload();
                    },
                    error: function(request, status, error){
                        alert("ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
                    }
                })
            }
        });

        $(".modify").click(function(e){
            e.preventDefault();
            let commentId = $(this).data("comment-id");

            let commentMsg = $(this).closest(".text").find("p").text();
            $("#commentModifyMsg").val(commentMsg);
            
            let msg = prompt("ÏàòÏ†ïÌïòÏã§ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
            if (msg) {
                console.log(msg); // ÏàòÏ†ïÎêú Î©îÏãúÏßÄ Ï∂úÎ†•
                $.ajax({
                    url: "boardCommentModify.php",
                    method: "POST",
                    data: {
                        "boardId": <?=$boardId?>,
                        "commentId": commentId,
                        "msg": msg
                    },
                    success: function(data){
                        location.reload();
                    },
                    error: function(request, status, error){
                        alert("ÎåìÍ∏Ä ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
                    }
                })
            }
        });
    </script>
</body>

</html>